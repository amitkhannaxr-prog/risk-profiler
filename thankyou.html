<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .wrap{max-width:900px;margin:0 auto;padding:40px 16px}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 10px 0;font-size:28px}
    p{margin:8px 0;line-height:1.5}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button,a.btn{border:0;border-radius:10px;padding:12px 14px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    button{background:#111;color:#fff}
    a.btn{background:#e9eaef;color:#111}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .small{color:#555;font-size:13px;margin-top:14px}
    .muted{color:#666}
  </style>

  <!-- jsPDF (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Thank you for filling the Risk Profiler Form.</h1>
      <p>Our Team will be in touch with you.</p>

      <div class="actions">
        <button id="downloadBtn" type="button" disabled>Download your responses (PDF)</button>
        <a class="btn" href="index.html">Fill again</a>
      </div>

      <p class="small muted">
        Note: Your score and risk profile are confidential and will be shared by our team separately.
      </p>
    </div>
  </div>

<script>
  const COMPANY_NAME = "Goalchi Capital Services LLP";
  const LOGO_PATH = "assets/logo.png";

  const QUESTIONS = [
  {
    "no": 1,
    "title": "Investment Time Horizon",
    "options": {
      "1": "Within 3 years",
      "2": "3–5 years",
      "3": "6–10 years",
      "4": "11–15 years",
      "5": "More than 15 years"
    }
  },
  {
    "no": 2,
    "title": "Liquidity Reserves",
    "options": {
      "1": "Less than 3 months",
      "2": "3–6 months",
      "3": "6–12 months",
      "4": "12–24 months",
      "5": "More than 24 months"
    }
  },
  {
    "no": 3,
    "title": "Income Stability",
    "options": {
      "1": "Highly unstable",
      "2": "Variable income",
      "3": "Moderately stable",
      "4": "Stable employment",
      "5": "Very stable / predictable"
    }
  },
  {
    "no": 4,
    "title": "Reaction to a 20% Market Decline",
    "options": {
      "1": "Sell all investments",
      "2": "Reduce exposure significantly",
      "3": "Maintain allocation",
      "4": "Increase modestly",
      "5": "Increase aggressively"
    }
  },
  {
    "no": 5,
    "title": "Maximum Temporary Portfolio Decline Tolerable",
    "options": {
      "1": "5%",
      "2": "10%",
      "3": "20%",
      "4": "30%",
      "5": "40%+"
    }
  },
  {
    "no": 6,
    "title": "Primary Investment Objective",
    "options": {
      "1": "Capital preservation",
      "2": "Low growth",
      "3": "Balanced growth",
      "4": "Strong growth",
      "5": "Maximum growth"
    }
  },
  {
    "no": 7,
    "title": "Preference Between Guaranteed vs Higher Potential Returns",
    "options": {
      "1": "Guaranteed return",
      "2": "Prefer lower risk",
      "3": "Balanced",
      "4": "Prefer higher return potential",
      "5": "Highest potential return"
    }
  },
  {
    "no": 8,
    "title": "Decision in a High-Stakes Scenario",
    "options": {
      "1": "Secure gains",
      "2": "Lean conservative",
      "3": "Neutral",
      "4": "Lean aggressive",
      "5": "Pursue maximum upside"
    }
  },
  {
    "no": 9,
    "title": "Investment Experience",
    "options": {
      "1": "None",
      "2": "Limited",
      "3": "Moderate",
      "4": "Experienced",
      "5": "Advanced"
    }
  },
  {
    "no": 10,
    "title": "Understanding of Market Risk",
    "options": {
      "1": "Very limited",
      "2": "Basic",
      "3": "Working knowledge",
      "4": "Strong",
      "5": "Advanced"
    }
  },
  {
    "no": 11,
    "title": "Comfort with Market Volatility",
    "options": {
      "1": "Low",
      "2": "Somewhat low",
      "3": "Moderate",
      "4": "High",
      "5": "Very high"
    }
  },
  {
    "no": 12,
    "title": "Expected Annual Return",
    "options": {
      "1": "4–6%",
      "2": "6–8%",
      "3": "8–10%",
      "4": "10–12%",
      "5": "12%+"
    }
  },
  {
    "no": 13,
    "title": "Reaction to Portfolio Underperformance",
    "options": {
      "1": "Exit immediately",
      "2": "Reduce exposure",
      "3": "Review strategy",
      "4": "Stay invested",
      "5": "Add more capital"
    }
  },
  {
    "no": 14,
    "title": "Long-Term Investment Philosophy",
    "options": {
      "1": "Defensive",
      "2": "Conservative",
      "3": "Balanced",
      "4": "Growth-focused",
      "5": "Aggressive growth"
    }
  },
  {
    "no": 15,
    "title": "Overall Risk Attitude",
    "options": {
      "1": "Risk-averse",
      "2": "Cautious",
      "3": "Moderate",
      "4": "Risk-tolerant",
      "5": "Risk-seeking"
    }
  }
];

  function safeParse(text) {
    try { return JSON.parse(text); } catch { return null; }
  }

  function formatSubmittedAt(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (isNaN(d)) return "-";
    return d.toLocaleString();
  }

  function loadImageAsDataUrl(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        try {
          const canvas = document.createElement("canvas");
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        } catch (e) {
          console.warn("Unable to convert logo", e);
          resolve(null);
        }
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  function addWatermark(doc) {
    const w = doc.internal.pageSize.getWidth();
    const h = doc.internal.pageSize.getHeight();
    doc.setTextColor(210);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(60);
    doc.text("CONFIDENTIAL", w / 2, h / 2, { align: "center", angle: 35 });
    doc.setTextColor(0);
  }

  function addHeaderFooter(doc, logoDataUrl, clientName, submittedAtText) {
    const w = doc.internal.pageSize.getWidth();
    const h = doc.internal.pageSize.getHeight();
    const marginX = 40;

    // Header
    if (logoDataUrl) {
      doc.addImage(logoDataUrl, "PNG", marginX, 14, 70, 24);
    }
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(COMPANY_NAME, w - marginX, 32, { align: "right" });

    doc.setDrawColor(220);
    doc.line(marginX, 46, w - marginX, 46);

    // Footer
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(100);
    doc.text(`Client: ${clientName || "-"}`, marginX, h - 22);
    doc.text(`Submitted: ${submittedAtText}`, w - marginX, h - 22, { align: "right" });
    doc.setTextColor(0);
  }

  function downloadPdf(submission) {
    const jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
    if (!jsPDF) {
      alert("PDF library is still loading. Please try again in a moment.");
      return;
    }

    const submittedAtText = formatSubmittedAt(submission.submittedAt);
    const clientName = submission.clientName || "Client";

    loadImageAsDataUrl(LOGO_PATH).then((logoDataUrl) => {
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const marginX = 40;
      const contentTop = 64;
      const contentBottom = 60;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const maxWidth = pageW - marginX * 2;
      let y = contentTop;

      const newPage = () => {
        addWatermark(doc);
        addHeaderFooter(doc, logoDataUrl, clientName, submittedAtText);
        y = contentTop;
      };

      const ensureSpace = () => {
        if (y > pageH - contentBottom) {
          doc.addPage();
          newPage();
        }
      };

      const writeLine = (text, fontStyle = "normal", fontSize = 11, gap = 0) => {
        doc.setFont("helvetica", fontStyle);
        doc.setFontSize(fontSize);
        const wrapped = doc.splitTextToSize(text, maxWidth);
        for (const line of wrapped) {
          ensureSpace();
          doc.text(line, marginX, y);
          y += 16;
        }
        y += gap;
      };

      newPage();
      writeLine("Risk Profiler Form - Client Responses", "bold", 14, 8);

      writeLine(`Name: ${submission.clientName || "-"}`);
      writeLine(`Email: ${submission.clientEmail || "-"}`);
      writeLine(`Mobile: ${submission.clientMobile || "-"}`);
      writeLine(`City: ${submission.clientCity || "-"}`, "normal", 11, 10);

      writeLine("Responses:", "bold", 12, 6);

      const answers = submission.answers || {};
      for (const q of QUESTIONS) {
        const key = "q" + q.no;
        const raw = answers[key];
        const resp = (raw && q.options && q.options[String(raw)]) ? q.options[String(raw)] : (raw ?? "-");
        writeLine(`Q${q.no}. ${q.title}`, "bold", 11, 0);
        writeLine(`Response: ${resp}`, "normal", 11, 8);
      }

      const safeName = (submission.clientName || "client")
        .replace(/[^a-z0-9\- ]/gi, "")
        .trim()
        .replace(/\s+/g, "_") || "client";

      doc.save(`risk_profiler_${safeName}.pdf`);
    });
  }

  const submission = safeParse(sessionStorage.getItem("riskProfilerSubmission") || "");
  const btn = document.getElementById("downloadBtn");

  function enableButtonWhenReady() {
    const jsPdfReady = !!(window.jspdf && window.jspdf.jsPDF);
    if (submission && jsPdfReady) {
      btn.disabled = false;
      return true;
    }
    return false;
  }

  // Enable when script finishes loading (defer) + poll a few times as safety
  let tries = 0;
  const timer = setInterval(() => {
    tries += 1;
    if (enableButtonWhenReady() || tries > 20) clearInterval(timer);
  }, 250);

  btn.addEventListener("click", () => {
    if (!submission) {
      alert("Please submit the form first, then download from this page.");
      return;
    }
    downloadPdf(submission);
  });
</script>
</body>
</html>
